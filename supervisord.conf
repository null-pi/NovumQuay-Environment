[supervisord]
nodaemon=true               ; Run supervisord in the foreground
user=root                   ; Run processes as root user

[program:vnc]
# The -fg flag is crucial: it tells vncserver to run in the foreground.
command=sh -c '/usr/bin/vncserver :1 -geometry ${VNC_RESOLUTION:-1920x1080} -depth ${VNC_COL_DEPTH:-24} -rfbport ${VNC_PORT:-5901} -localhost no -SecurityTypes None --I-KNOW-THIS-IS-INSECURE -fg'
priority=10                 ; Start VNC first
autorestart=true            ; Restart if it crashes
stdout_logfile=/dev/stdout  ; Redirect stdout to container's stdout
stdout_logfile_maxbytes=0   ; Disable log rotation for stdout
stderr_logfile=/dev/stderr  ; Redirect stderr to container's stderr
stderr_logfile_maxbytes=0   ; Disable log rotation for stderr

[program:novnc]
# Use environment variables with fallbacks for port numbers
command=sh -c '/usr/bin/websockify --web /usr/share/novnc/ ${NOVNC_PORT:-6901} localhost:${VNC_PORT:-5901}'
priority=20                 ; Start after VNC
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

[program:codeserver]
command=sh -c '/usr/bin/code-server --bind-addr 0.0.0.0:${CODE_SERVER_PORT:-8443} --auth none'
priority=20                 ; Start after VNC
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0